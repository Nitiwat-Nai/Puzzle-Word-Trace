<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Word Trace üëë</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;800&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        /* --- 1. MODERN THEME VARIABLES --- */
        :root {
            --primary: #6C63FF;       /* Modern Purple/Blue */
            --primary-dark: #5A52D5;
            --accent: #FF6584;        /* Soft Coral/Pink */
            --bg-color: #F7F9FC;      /* Very Light Blue-Grey */
            --card-bg: #FFFFFF;
            --text-main: #2D3748;
            --text-light: #FFFFFF;
            --success: #00D2A0;       /* Mint */
            --error: #FF5C5C;         /* Soft Red */
            --gold: #FFB74D;          /* Warm Yellow */
            
            --level1-bg: #FFF8E5;     /* Lighter background for L1 buttons */
            --level2-bg: #FFE9EC;     /* Lighter background for L2 buttons */
            --level3-bg: #E7E6FF;     /* Lighter background for L3 buttons */
            
            --shadow: 0 10px 25px rgba(108, 99, 255, 0.15);
            --shadow-sm: 0 4px 10px rgba(0,0,0,0.05);
            --radius: 20px;
            --radius-sm: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            /* Prevent bounce effect on mobile */
            overscroll-behavior: none; 
        }

        .container {
            width: 100%;
            max-width: 480px; /* Limit width for mobile feel on desktop */
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* --- HEADER --- */
        header {
            background: var(--card-bg);
            padding: 1rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            z-index: 10;
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
        }

        header h1 {
            font-family: 'Fredoka One', cursive; /* Fun font for title */
            font-size: 2rem;
            margin: 0;
            color: var(--primary);
            letter-spacing: 1px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        /* Secret Mode Indicator */
        .auto-mode-active h1 {
            color: var(--accent) !important;
            animation: bounce-pulse 2s infinite;
        }
        
        @keyframes bounce-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* --- SCREENS --- */
        .screen {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 1.5rem;
            overflow-y: auto;
            align-items: center;
            /* V7.1 FIX: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏≠‡πà‡∏≠‡∏ô */
            background-color: #FFF8F8;
        }
        .screen.active { display: flex; }

        /* --- LEVEL SELECT --- */
        .level-grid-select {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            padding-bottom: 2rem;
        }

        .level-btn {
            border: none;
            padding: 1.5rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-main);
            box-shadow: 0 4px 0 #CBD5E0; /* Soft 3D effect */
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s, background 0.2s;
            position: relative;
            overflow: hidden;
        }

        /* V7.1 FIX: ‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏° Level */
        .level-btn[data-level='1'] { background-color: var(--level1-bg); border-bottom: 4px solid var(--gold); }
        .level-btn[data-level='2'] { background-color: var(--level2-bg); border-bottom: 4px solid var(--accent); }
        .level-btn[data-level='3'] { background-color: var(--level3-bg); border-bottom: 4px solid var(--primary); }

        .level-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #CBD5E0;
        }

        /* --- GAME SCREEN --- */
        .status-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #718096;
            font-weight: 600;
        }

        .game-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 1.5rem;
            width: 100%;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: auto; 
        }

        #prompt-area {
            text-align: center;
            margin-bottom: 1rem;
            width: 100%;
        }

        #thai-prompt {
            font-size: 1.1rem;
            color: #718096;
            margin-bottom: 0.5rem;
        }

        #english-word-display {
            font-family: 'Fredoka One', cursive;
            font-size: 2.5rem;
            color: var(--primary);
            min-height: 3.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Timer */
        #timer-bar-container {
            width: 100%;
            height: 8px;
            background-color: #EDF2F7;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        #timer-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width 0.1s linear;
        }

        /* GRID */
        #game-grid {
            display: grid;
            gap: 10px;
            width: 100%;
            max-width: 350px;
            aspect-ratio: 1 / 1;
        }

        .tile {
            background-color: #EDF2F7;
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Fredoka One', cursive;
            font-size: 2rem;
            color: var(--text-main);
            box-shadow: 0 4px 0 #CBD5E0;
        }

        .tile:active { transform: scale(0.95); }

        .tile.selected {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 0 var(--primary-dark);
            transform: translateY(2px);
        }

        .tile.correct {
            background-color: var(--success);
            color: white;
            box-shadow: 0 4px 0 #00A880;
            animation: pop 0.3s;
        }

        @keyframes pop { 50% { transform: scale(1.1); } }

        /* Message Area */
        #message-area {
            margin-top: 1rem;
            height: 1.5rem;
            font-weight: 600;
            color: var(--text-main);
        }

        /* --- CONTROLS --- */
        #game-controls {
            width: 100%;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .control-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 50px;
            font-family: 'Sarabun', sans-serif;
            font-size: 1.2rem;
            font-weight: 800;
            color: white;
            background: var(--primary);
            box-shadow: 0 6px 0 var(--primary-dark);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            margin-bottom: 10px;
        }

        .control-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 var(--primary-dark);
        }

        .secondary-btn {
            background: #A0AEC0;
            box-shadow: 0 6px 0 #718096;
        }
        .secondary-btn:active { box-shadow: 0 2px 0 #718096; }

        .success-btn {
            background: var(--success);
            box-shadow: 0 6px 0 #00A880;
        }
        .success-btn:active { box-shadow: 0 2px 0 #00A880; }

        /* Control Groups */
        .btn-group {
            display: flex;
            gap: 10px;
        }
        .btn-group .control-btn { flex: 1; }

    </style>
</head>
<body>

    <div class="container" id="main-container">
        <header id="game-header">
            <h1 id="game-title">Word Trace üëë</h1>
        </header>

        <div id="level-select-screen" class="screen active">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="margin:0; color:var(--text-main);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô</h2>
                <p style="margin:5px 0 0; color:#718096;">‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</p>
            </div>
            <div class="level-grid-select" id="level-grid-select"></div>
        </div>
        
        <div id="game-screen" class="screen">
            <div class="status-bar">
                <span id="level-title">Level 1-1</span>
                <span id="q-count">‡∏Ç‡πâ‡∏≠: 1/10</span>
                <span id="score">‚≠ê 0</span>
            </div>

            <div class="game-card">
                <div id="timer-bar-container">
                    <div id="timer-bar"></div>
                </div>

                <div id="prompt-area">
                    <div id="thai-prompt">‡πÅ‡∏°‡∏ß</div>
                    <div id="english-word-display"></div>
                </div>
                
                <div id="game-grid"></div>
                
                <div id="message-area"></div>
            </div>
            
            <div id="game-controls">
                <button id="pause-btn" class="control-btn">‡∏´‡∏¢‡∏∏‡∏î ‚è∏Ô∏è</button>
                
                <div id="paused-controls" class="btn-group" style="display: none;">
                    <button id="resume-btn" class="control-btn">‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠ ‚ñ∂Ô∏è</button>
                    <button id="main-menu-btn-pause" class="control-btn secondary-btn">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π üè†</button>
                </div>
                
                <div id="end-level-controls" class="btn-group" style="display: none;">
                    <button id="play-again-btn" class="control-btn success-btn">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà üîÑ</button>
                    <button id="main-menu-btn-end" class="control-btn secondary-btn">‡πÄ‡∏°‡∏ô‡∏π üè†</button>
                </div>
                
                <button id="next-q-btn" class="control-btn success-btn" style="display: none;">‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚è≠Ô∏è</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA CONFIGURATION ---
        
        function getRandomDistractorChar(excludeChars = []) {
            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const availableChars = alphabet.split('').filter(char => !excludeChars.includes(char));
            return availableChars.length ? availableChars[Math.floor(Math.random() * availableChars.length)] : 'Z';
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateTiles(word, gridSize) {
            const tiles = [];
            const tileCount = gridSize * gridSize;
            const wordChars = word.split('');
            const wordLength = word.length;
            const excludeChars = [...new Set(wordChars)]; 

            const pathIndices = [];
            while(pathIndices.length < wordLength) {
                const randomIndex = Math.floor(Math.random() * tileCount);
                if (pathIndices.indexOf(randomIndex) === -1) pathIndices.push(randomIndex);
            }

            for (let i = 0; i < tileCount; i++) {
                const charIndex = pathIndices.indexOf(i);
                tiles.push({
                    char: charIndex !== -1 ? wordChars[charIndex] : getRandomDistractorChar(excludeChars),
                    order: charIndex + 1,
                    tileIndex: i
                });
            }
            return tiles;
        }
        
        // Function to apply time reduction (3 seconds)
        function adjustTimeLimit(originalTime) {
            return Math.max(3, originalTime - 3); 
        }

        const rawWordData = {
            level1Words: [
                { correctWord: "CAT", thaiPrompt: "‡πÅ‡∏°‡∏ß", timeLimit: 12 }, { correctWord: "DOG", thaiPrompt: "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç", timeLimit: 12 }, { correctWord: "SUN", thaiPrompt: "‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", timeLimit: 12 }, { correctWord: "MOON", thaiPrompt: "‡∏û‡∏£‡∏∞‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", timeLimit: 15 }, { correctWord: "FISH", thaiPrompt: "‡∏õ‡∏•‡∏≤", timeLimit: 15 },
                { correctWord: "TREE", thaiPrompt: "‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ", timeLimit: 12 }, { correctWord: "BIRD", thaiPrompt: "‡∏ô‡∏Å", timeLimit: 12 }, { correctWord: "BLUE", thaiPrompt: "‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", timeLimit: 15 }, { correctWord: "RED", thaiPrompt: "‡∏™‡∏µ‡πÅ‡∏î‡∏á", timeLimit: 12 }, { correctWord: "RICE", thaiPrompt: "‡∏Ç‡πâ‡∏≤‡∏ß", timeLimit: 15 },
                { correctWord: "BOOK", thaiPrompt: "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", timeLimit: 15 }, { correctWord: "CAR", thaiPrompt: "‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå", timeLimit: 12 }, { correctWord: "BUS", thaiPrompt: "‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á", timeLimit: 12 }, { correctWord: "HOME", thaiPrompt: "‡∏ö‡πâ‡∏≤‡∏ô", timeLimit: 15 }, { correctWord: "BALL", thaiPrompt: "‡∏•‡∏π‡∏Å‡∏ö‡∏≠‡∏•", timeLimit: 15 },
                { correctWord: "HAND", thaiPrompt: "‡∏°‡∏∑‡∏≠", timeLimit: 15 }, { correctWord: "FOOT", thaiPrompt: "‡πÄ‡∏ó‡πâ‡∏≤", timeLimit: 15 }, { correctWord: "FARM", thaiPrompt: "‡∏ü‡∏≤‡∏£‡πå‡∏°", timeLimit: 15 }, { correctWord: "STAR", thaiPrompt: "‡∏î‡∏≤‡∏ß", timeLimit: 15 }, { correctWord: "SHIP", thaiPrompt: "‡πÄ‡∏£‡∏∑‡∏≠", timeLimit: 15 },
                { correctWord: "RAIN", thaiPrompt: "‡∏ù‡∏ô", timeLimit: 15 }, { correctWord: "WIND", thaiPrompt: "‡∏•‡∏°", timeLimit: 15 }, { correctWord: "ROAD", thaiPrompt: "‡∏ñ‡∏ô‡∏ô", timeLimit: 15 }, { correctWord: "FIRE", thaiPrompt: "‡πÑ‡∏ü", timeLimit: 15 }, { correctWord: "LAKE", thaiPrompt: "‡∏ó‡∏∞‡πÄ‡∏•‡∏™‡∏≤‡∏ö", timeLimit: 15 },
                { correctWord: "WANT", thaiPrompt: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", timeLimit: 15 }, { correctWord: "KNOW", thaiPrompt: "‡∏£‡∏π‡πâ", timeLimit: 12 }, { correctWord: "LOVE", thaiPrompt: "‡∏£‡∏±‡∏Å", timeLimit: 12 }, { correctWord: "HELP", thaiPrompt: "‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠", timeLimit: 15 }, { correctWord: "NAME", thaiPrompt: "‡∏ä‡∏∑‡πà‡∏≠", timeLimit: 12 },
                { correctWord: "PLAY", thaiPrompt: "‡πÄ‡∏•‡πà‡∏ô", timeLimit: 12 }, { correctWord: "SICK", thaiPrompt: "‡∏õ‡πà‡∏ß‡∏¢", timeLimit: 15 }, { correctWord: "FAST", thaiPrompt: "‡πÄ‡∏£‡πá‡∏ß", timeLimit: 15 }, { correctWord: "SLOW", thaiPrompt: "‡∏ä‡πâ‡∏≤", timeLimit: 15 }, { correctWord: "DARK", thaiPrompt: "‡∏°‡∏∑‡∏î", timeLimit: 12 },
                { correctWord: "LIGHT", thaiPrompt: "‡πÅ‡∏™‡∏á", timeLimit: 15 }, { correctWord: "OPEN", thaiPrompt: "‡πÄ‡∏õ‡∏¥‡∏î", timeLimit: 12 }, { correctWord: "STOP", thaiPrompt: "‡∏´‡∏¢‡∏∏‡∏î", timeLimit: 12 }, { correctWord: "WALK", thaiPrompt: "‡πÄ‡∏î‡∏¥‡∏ô", timeLimit: 15 }, { correctWord: "TALK", thaiPrompt: "‡∏û‡∏π‡∏î", timeLimit: 12 },
                { correctWord: "GATE", thaiPrompt: "‡∏õ‡∏£‡∏∞‡∏ï‡∏π", timeLimit: 15 }, { correctWord: "FOOD", thaiPrompt: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", timeLimit: 15 }, { correctWord: "DRINK", thaiPrompt: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", timeLimit: 15 }, { correctWord: "EARS", thaiPrompt: "‡∏´‡∏π", timeLimit: 12 }, { correctWord: "EYE", thaiPrompt: "‡∏ï‡∏≤", timeLimit: 12 },
                { correctWord: "SING", thaiPrompt: "‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á", timeLimit: 15 }, { correctWord: "JUMP", thaiPrompt: "‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î", timeLimit: 15 }, { correctWord: "BELL", thaiPrompt: "‡∏£‡∏∞‡∏Ü‡∏±‡∏á", timeLimit: 12 }, { correctWord: "KING", thaiPrompt: "‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏≤", timeLimit: 12 }, { correctWord: "DOOR", thaiPrompt: "‡∏õ‡∏£‡∏∞‡∏ï‡∏π", timeLimit: 15 }
            ],
            level2Words: [
                { correctWord: "APPLE", thaiPrompt: "‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•", timeLimit: 18 }, { correctWord: "PEACH", thaiPrompt: "‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä", timeLimit: 18 }, { correctWord: "TIGER", thaiPrompt: "‡πÄ‡∏™‡∏∑‡∏≠", timeLimit: 18 }, { correctWord: "CHAIR", thaiPrompt: "‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ", timeLimit: 18 }, { correctWord: "YELLOW", thaiPrompt: "‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", timeLimit: 20 },
                { correctWord: "SLEEP", thaiPrompt: "‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö", timeLimit: 18 }, { correctWord: "FAMILY", thaiPrompt: "‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", timeLimit: 20 }, { correctWord: "BROTHER", thaiPrompt: "‡∏û‡∏µ‡πà‡∏ä‡∏≤‡∏¢/‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏≤‡∏¢", timeLimit: 20 }, { correctWord: "SISTER", thaiPrompt: "‡∏û‡∏µ‡πà‡∏™‡∏≤‡∏ß/‡∏ô‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏ß", timeLimit: 20 }, { correctWord: "FRIEND", thaiPrompt: "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô", timeLimit: 18 },
                { correctWord: "SCHOOL", thaiPrompt: "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", timeLimit: 20 }, { correctWord: "STUDY", thaiPrompt: "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", timeLimit: 18 }, { correctWord: "TEACH", thaiPrompt: "‡∏™‡∏≠‡∏ô", timeLimit: 18 }, { correctWord: "WRITER", thaiPrompt: "‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô", timeLimit: 20 }, { correctWord: "GARDEN", thaiPrompt: "‡∏™‡∏ß‡∏ô", timeLimit: 20 },
                { correctWord: "FLOWER", thaiPrompt: "‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ", timeLimit: 20 }, { correctWord: "WATER", thaiPrompt: "‡∏ô‡πâ‡∏≥", timeLimit: 18 }, { correctWord: "OCEAN", thaiPrompt: "‡∏°‡∏´‡∏≤‡∏™‡∏°‡∏∏‡∏ó‡∏£", timeLimit: 18 }, { correctWord: "MOUNTAIN", thaiPrompt: "‡∏†‡∏π‡πÄ‡∏Ç‡∏≤", timeLimit: 20 }, { correctWord: "STREET", thaiPrompt: "‡∏ñ‡∏ô‡∏ô", timeLimit: 18 },
                { correctWord: "BUILD", thaiPrompt: "‡∏™‡∏£‡πâ‡∏≤‡∏á", timeLimit: 18 }, { correctWord: "TRAVEL", thaiPrompt: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", timeLimit: 20 }, { correctWord: "EATING", thaiPrompt: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏¥‡∏ô", timeLimit: 20 }, { correctWord: "SMART", thaiPrompt: "‡∏â‡∏•‡∏≤‡∏î", timeLimit: 18 }, { correctWord: "CLEVER", thaiPrompt: "‡πÄ‡∏Å‡πà‡∏á", timeLimit: 18 },
                { correctWord: "HAPPY", thaiPrompt: "‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç", timeLimit: 20 }, { correctWord: "SMILE", thaiPrompt: "‡∏¢‡∏¥‡πâ‡∏°", timeLimit: 18 }, { correctWord: "DANCE", thaiPrompt: "‡πÄ‡∏ï‡πâ‡∏ô‡∏£‡∏≥", timeLimit: 18 }, { correctWord: "CLOUDY", thaiPrompt: "‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏°‡∏≤‡∏Å", timeLimit: 20 }, { correctWord: "WINTER", thaiPrompt: "‡∏§‡∏î‡∏π‡∏´‡∏ô‡∏≤‡∏ß", timeLimit: 20 },
                { correctWord: "SUMMER", thaiPrompt: "‡∏§‡∏î‡∏π‡∏£‡πâ‡∏≠‡∏ô", timeLimit: 20 }, { correctWord: "SPRING", thaiPrompt: "‡∏§‡∏î‡∏π‡πÉ‡∏ö‡πÑ‡∏°‡πâ‡∏ú‡∏•‡∏¥", timeLimit: 20 }, { correctWord: "AUTUMN", thaiPrompt: "‡∏§‡∏î‡∏π‡πÉ‡∏ö‡πÑ‡∏°‡πâ‡∏£‡πà‡∏ß‡∏á", timeLimit: 20 }, { correctWord: "CHICKEN", thaiPrompt: "‡πÑ‡∏Å‡πà", timeLimit: 20 }, { correctWord: "BUTTER", thaiPrompt: "‡πÄ‡∏ô‡∏¢", timeLimit: 20 },
                { correctWord: "CHEESE", thaiPrompt: "‡πÄ‡∏ô‡∏¢‡πÅ‡∏Ç‡πá‡∏á", timeLimit: 20 }, { correctWord: "SUGAR", thaiPrompt: "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•", timeLimit: 20 }, { correctWord: "SALT", thaiPrompt: "‡πÄ‡∏Å‡∏•‡∏∑‡∏≠", timeLimit: 18 }, { correctWord: "PIRATE", thaiPrompt: "‡πÇ‡∏à‡∏£‡∏™‡∏•‡∏±‡∏î", timeLimit: 20 }, { correctWord: "POLICE", thaiPrompt: "‡∏ï‡∏≥‡∏£‡∏ß‡∏à", timeLimit: 20 },
                { correctWord: "DOCTOR", thaiPrompt: "‡∏´‡∏°‡∏≠", timeLimit: 18 }, { correctWord: "NURSE", thaiPrompt: "‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•", timeLimit: 18 }, { correctWord: "ENGINE", thaiPrompt: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå", timeLimit: 20 }, { correctWord: "TICKET", thaiPrompt: "‡∏ï‡∏±‡πã‡∏ß", timeLimit: 20 }, { correctWord: "PLANET", thaiPrompt: "‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", timeLimit: 20 },
                { correctWord: "FUTURE", thaiPrompt: "‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï", timeLimit: 20 }, { correctWord: "MOMENT", thaiPrompt: "‡∏ä‡∏±‡πà‡∏ß‡∏Ç‡∏ì‡∏∞", timeLimit: 20 }, { correctWord: "PERSON", thaiPrompt: "‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•", timeLimit: 20 }, { correctWord: "PEOPLE", thaiPrompt: "‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô", timeLimit: 20 }, { correctWord: "SYSTEM", thaiPrompt: "‡∏£‡∏∞‡∏ö‡∏ö", timeLimit: 20 }
            ],
            level3Words: [
                { correctWord: "ELEPHANT", thaiPrompt: "‡∏ä‡πâ‡∏≤‡∏á", timeLimit: 25 }, { correctWord: "COMPUTER", thaiPrompt: "‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå", timeLimit: 25 }, { correctWord: "LIBRARY", thaiPrompt: "‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î", timeLimit: 22 }, { correctWord: "UNIVERSITY", thaiPrompt: "‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢", timeLimit: 30 }, { correctWord: "WEATHER", thaiPrompt: "‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®", timeLimit: 25 },
                { correctWord: "HOSPITAL", thaiPrompt: "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•", timeLimit: 25 }, { correctWord: "BUILDING", thaiPrompt: "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£", timeLimit: 22 }, { correctWord: "MAGAZINE", thaiPrompt: "‡∏ô‡∏¥‡∏ï‡∏¢‡∏™‡∏≤‡∏£", timeLimit: 25 }, { correctWord: "HOLIDAY", thaiPrompt: "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î", timeLimit: 22 }, { correctWord: "VACATION", thaiPrompt: "‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô", timeLimit: 25 },
                { correctWord: "BEAUTIFUL", thaiPrompt: "‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°", timeLimit: 30 }, { correctWord: "DIFFICULT", thaiPrompt: "‡∏¢‡∏≤‡∏Å", timeLimit: 25 }, { correctWord: "INTEREST", thaiPrompt: "‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à", timeLimit: 25 }, { correctWord: "EXCELLENT", thaiPrompt: "‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°", timeLimit: 25 }, { correctWord: "COMPLETE", thaiPrompt: "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå", timeLimit: 25 },
                { correctWord: "TOGETHER", thaiPrompt: "‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô", timeLimit: 25 }, { correctWord: "LANGUAGE", thaiPrompt: "‡∏†‡∏≤‡∏©‡∏≤", timeLimit: 25 }, { correctWord: "HISTORY", thaiPrompt: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", timeLimit: 30 }, { correctWord: "SCIENCE", thaiPrompt: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", timeLimit: 25 }, { correctWord: "MATHEMATICS", thaiPrompt: "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", timeLimit: 30 },
                { correctWord: "GEOGRAPHY", thaiPrompt: "‡∏†‡∏π‡∏°‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", timeLimit: 30 }, { correctWord: "TECHNOLOGY", thaiPrompt: "‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", timeLimit: 30 }, { correctWord: "TELEPHONE", thaiPrompt: "‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", timeLimit: 25 }, { correctWord: "INTERNET", thaiPrompt: "‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï", timeLimit: 25 }, { correctWord: "COMMUNITY", thaiPrompt: "‡∏ä‡∏∏‡∏°‡∏ä‡∏ô", timeLimit: 25 },
                { correctWord: "DIRECTION", thaiPrompt: "‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á", timeLimit: 25 }, { correctWord: "SOLUTION", thaiPrompt: "‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤", timeLimit: 25 }, { correctWord: "QUESTION", thaiPrompt: "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°", timeLimit: 25 }, { correctWord: "ANSWER", thaiPrompt: "‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö", timeLimit: 25 }, { correctWord: "MATERIAL", thaiPrompt: "‡∏ß‡∏±‡∏™‡∏î‡∏∏", timeLimit: 25 },
                { correctWord: "ACTIVITY", thaiPrompt: "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", timeLimit: 25 }, { correctWord: "POSITION", thaiPrompt: "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á", timeLimit: 25 }, { correctWord: "GOVERNMENT", thaiPrompt: "‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•", timeLimit: 30 }, { correctWord: "PRESIDENT", thaiPrompt: "‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ", timeLimit: 30 }, { correctWord: "MINISTER", thaiPrompt: "‡∏£‡∏±‡∏ê‡∏°‡∏ô‡∏ï‡∏£‡∏µ", timeLimit: 25 },
                { correctWord: "BUSINESS", thaiPrompt: "‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", timeLimit: 25 }, { correctWord: "INDUSTRY", thaiPrompt: "‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°", timeLimit: 30 }, { correctWord: "CUSTOMER", thaiPrompt: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", timeLimit: 25 }, { correctWord: "DEVELOPER", thaiPrompt: "‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤", timeLimit: 25 }, { correctWord: "PROGRAMMER", thaiPrompt: "‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå", timeLimit: 30 },
                { correctWord: "ADVENTURE", thaiPrompt: "‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢", timeLimit: 30 }, { correctWord: "TRADITION", thaiPrompt: "‡∏õ‡∏£‡∏∞‡πÄ‡∏û‡∏ì‡∏µ", timeLimit: 25 }, { correctWord: "CULTURE", thaiPrompt: "‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°", timeLimit: 25 }, { correctWord: "POPULAR", thaiPrompt: "‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏¢‡∏°", timeLimit: 25 }, { correctWord: "SURPRISE", thaiPrompt: "‡∏õ‡∏£‡∏∞‡∏´‡∏•‡∏≤‡∏î‡πÉ‡∏à", timeLimit: 25 },
                { correctWord: "CREATIVE", thaiPrompt: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå", timeLimit: 25 }, { correctWord: "DIAMOND", thaiPrompt: "‡πÄ‡∏û‡∏ä‡∏£", timeLimit: 25 }, { correctWord: "TREASURE", thaiPrompt: "‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥", timeLimit: 25 }, { correctWord: "EXPLORER", thaiPrompt: "‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à", timeLimit: 25 }, { correctWord: "PHARAOH", thaiPrompt: "‡∏ü‡∏≤‡πÇ‡∏£‡∏´‡πå", timeLimit: 25 }
            ]
        };

        const createLevelQuestions = (words, gridSizeFunc) => {
            return words.map(q => {
                const gridSize = gridSizeFunc(q.correctWord.length);
                return {
                    ...q, 
                    tiles: generateTiles(q.correctWord, gridSize), 
                    gridSize: gridSize,
                    timeLimit: Math.max(3, q.timeLimit - 3)
                };
            });
        };

        const allQuizData = [
            { level: 1, title: "Beginner", questions: createLevelQuestions(rawWordData.level1Words, () => 3) },
            { level: 2, title: "Intermediate", questions: createLevelQuestions(rawWordData.level2Words, () => 4) },
            { level: 3, title: "Advanced", questions: createLevelQuestions(rawWordData.level3Words, (len) => len > 9 ? 6 : 5) }
        ];

        // --- DOM ELEMENTS ---
        const gameTitleEl = document.getElementById('game-title');
        const levelGridSelectEl = document.getElementById('level-grid-select');
        const scoreEl = document.getElementById('score');
        const levelTitleEl = document.getElementById('level-title');
        const thaiPromptEl = document.getElementById('thai-prompt');
        const englishWordDisplayEl = document.getElementById('english-word-display');
        const gameGridEl = document.getElementById('game-grid');
        const timerBarEl = document.getElementById('timer-bar');
        const messageAreaEl = document.getElementById('message-area');
        
        // Buttons
        const pauseBtn = document.getElementById('pause-btn');
        const nextQBtn = document.getElementById('next-q-btn'); 
        const pausedControlsEl = document.getElementById('paused-controls');
        const endLevelControlsEl = document.getElementById('end-level-controls');

        // --- GAME STATE ---
        let currentLevelData = null;
        let originalLevelData = null;
        let currentQuizIndex = 0;
        let score = 0;
        let isAnswered = false;
        let timerInterval = null;
        let timeRemaining = 0;
        let totalTime = 0;
        let isGameActive = false;
        let isPaused = false; 
        let isAutoPlayMode = false; 
        let autoPlayTimeout = null; 
        let utterance = null; 
        
        let currentGuessWord = "";
        let nextExpectedChar = ""; 
        
        const autoNextQDelay = 5500; 
        let autoNextQTransitionTimeout = null; 

        // --- TTS SYSTEM ---
        function setupSpeech() {
            if ('speechSynthesis' in window) {
                utterance = new SpeechSynthesisUtterance();
                utterance.volume = 1; 
                utterance.rate = 1;
            }
        }
        
        function speak(text, lang, onEndCallback = null) {
            if (utterance) {
                window.speechSynthesis.cancel();
                
                // CRITICAL FIX: Convert English words to lowercase to prevent spelling out
                if (lang.includes('en')) {
                    utterance.text = text.toLowerCase(); 
                } else {
                    utterance.text = text;
                }
                
                utterance.lang = lang;
                
                const voices = window.speechSynthesis.getVoices();
                if (lang.startsWith('en')) {
                    utterance.voice = voices.find(v => v.lang === 'en-US') || voices.find(v => v.lang.startsWith('en'));
                } else if (lang.startsWith('th')) {
                    utterance.voice = voices.find(v => v.lang === 'th-TH') || voices.find(v => v.lang.startsWith('th'));
                }
                
                utterance.onend = onEndCallback;
                
                try { window.speechSynthesis.speak(utterance); } 
                catch(e) { console.error("TTS Error:", e); }
            } else if (onEndCallback) {
                onEndCallback(); 
            }
        }
        
        // V6.1: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç speakAnswer ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Fixed Delay ‡πÅ‡∏ó‡∏ô onend
        function speakAnswer(englishWord, thaiMeaning) {
            
            const isLastQuestion = currentQuizIndex + 1 >= currentLevelData.questions.length;

            const onSpeakEndCleanup = () => {
                 if(utterance) utterance.onend = null;
            };

            const onEnglishSpeakEnd = () => {
                 speak(thaiMeaning, 'th-TH', onSpeakEndCleanup);
            };

            speak(englishWord, 'en-US', onEnglishSpeakEnd);
            
            // Guaranteed flow transition using setTimeout
            if (isAutoPlayMode) {
                 clearTimeout(autoNextQTransitionTimeout);
                 
                 // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏á 5.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                 autoNextQTransitionTimeout = setTimeout(() => {
                      if (isAnswered && !isPaused) { // Check isPaused state here too
                          if (!isLastQuestion) {
                              currentQuizIndex++;
                              nextQuestion(); 
                          } else {
                              endGame();
                          }
                      }
                 }, autoNextQDelay); 
            } else {
                 nextQBtn.style.display = 'block';
            }
        }

        // --- CORE FUNCTIONS ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'level-select-screen') messageAreaEl.textContent = "";
        }

        function createLevelButtons() {
            levelGridSelectEl.innerHTML = '';
            const levelData = allQuizData.map(data => ({
                ...data,
                subLevels: Array.from({ length: 5 }, (_, i) => ({ 
                    id: `${data.level}-${i + 1}`,
                    title: `‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${i + 1}`,
                    questions: shuffleArray([...data.questions]).slice(i * 10, (i + 1) * 10), 
                    index: i,
                    originalLevel: data, 
                }))
            }));

            levelData.forEach(data => {
                data.subLevels.forEach((subLevel) => {
                    const btn = document.createElement('button');
                    btn.className = 'level-btn';
                    btn.textContent = `Level ${data.level}-${subLevel.index + 1}`;
                    btn.setAttribute('data-level', data.level);
                    btn.onclick = () => startGame(data, subLevel);
                    levelGridSelectEl.appendChild(btn);
                });
            });
        }

        function startGame(levelData, subLevelData, isRestart = false) {
            if (!isRestart) originalLevelData = { levelData, subLevelData };
            
            currentLevelData = {
                ...levelData,
                questions: isRestart ? shuffleArray([...levelData.questions]).slice(subLevelData.index * 10, (subLevelData.index + 1) * 10) : subLevelData.questions,
                subLevelIndex: subLevelData.index
            }; 
            currentQuizIndex = 0;
            score = 0;
            showScreen('game-screen');
            nextQuestion();
        }

        function nextQuestion() {
            window.speechSynthesis.cancel();
            clearAutoPlay();
            clearTimeout(autoNextQTransitionTimeout);
            
            if (!currentLevelData || currentQuizIndex >= currentLevelData.questions.length) {
                endGame();
                return;
            }
            
            isAnswered = false;
            isPaused = false;
            
            // Reset UI
            pauseBtn.style.display = 'block';
            pausedControlsEl.style.display = 'none';
            endLevelControlsEl.style.display = 'none';
            nextQBtn.style.display = 'none';
            
            // Update Status
            levelTitleEl.textContent = `Level ${currentLevelData.level}-${currentLevelData.subLevelIndex + 1}`;
            document.getElementById('q-count').textContent = `‡∏Ç‡πâ‡∏≠: ${currentQuizIndex + 1}/10`;
            scoreEl.textContent = `‚≠ê ${score}`;

            const q = currentLevelData.questions[currentQuizIndex];
            
            // V7.1 FIX: Call setupQuestion to ensure grid creation
            setupQuestion(q); 
            
            startTimer(q.timeLimit);
            
            if (isAutoPlayMode) startAutoPlay(q);
        }

        function setupQuestion(q) {
            thaiPromptEl.textContent = q.thaiPrompt;
            englishWordDisplayEl.textContent = ""; // Clear displayed word
            
            // V7.1 FIX: Ensure createGrid is called here!
            createGrid(q, q.gridSize); 
            
            resetGuess();
        }

        function createGrid(q, gridSize) {
            gameGridEl.innerHTML = '';
            gameGridEl.style.gridTemplateColumns = `repeat(${q.gridSize}, 1fr)`;

            q.tiles.forEach((tileData, index) => {
                const tileEl = document.createElement('div');
                tileEl.className = 'tile';
                const charWrapper = document.createElement('div');
                charWrapper.className = 'tile-char-wrapper';
                charWrapper.textContent = tileData.char;
                tileEl.appendChild(charWrapper);
                
                tileEl.onclick = () => handleTileClick(tileEl, tileData.char, tileData.order);
                gameGridEl.appendChild(tileEl);
            });
        }

        function resetGuess() {
            const q = currentLevelData.questions[currentQuizIndex];
            currentGuessWord = "";
            nextExpectedChar = q.correctWord.charAt(0);
            englishWordDisplayEl.textContent = "";
            
            document.querySelectorAll('.tile').forEach(t => {
                t.classList.remove('selected', 'correct');
                t.style.opacity = '1';
            });
            
            messageAreaEl.textContent = `‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö... (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà ${nextExpectedChar})`;
            messageAreaEl.style.color = '#718096';
        }

        function handleTileClick(tileEl, char, order) {
            if (isAutoPlayMode) return; 
            if (!isGameActive || isAnswered || tileEl.classList.contains('selected') || isPaused) return;

            if (char === nextExpectedChar) {
                currentGuessWord += char;
                tileEl.classList.add('selected');
                englishWordDisplayEl.textContent = currentGuessWord;
                checkFlow();
            } else {
                messageAreaEl.textContent = `‚ùå ‡∏ú‡∏¥‡∏î! ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î '${nextExpectedChar}'`;
                messageAreaEl.style.color = 'var(--error)';
                
                tileEl.style.transform = 'translateX(5px)';
                setTimeout(() => tileEl.style.transform = 'none', 200);
                
                setTimeout(() => {
                    if(!isAnswered) {
                        messageAreaEl.textContent = `‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö... (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà ${nextExpectedChar})`;
                        messageAreaEl.style.color = '#718096';
                    }
                }, 1000);
            }
        }

        function checkFlow(timeUp = false) {
            const q = currentLevelData.questions[currentQuizIndex];
            
            if (currentGuessWord.length < q.correctWord.length) {
                nextExpectedChar = q.correctWord.charAt(currentGuessWord.length);
            } else {
                isAnswered = true;
                score++;
                successEffect();
            }

            if (timeUp) {
                isAnswered = true;
                failEffect();
            }
        }

        function successEffect() {
            clearAutoPlay();
            messageAreaEl.textContent = "‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!";
            messageAreaEl.style.color = 'var(--success)';
            highlightAll(true);
            endQuestion();
        }

        function failEffect() {
            clearAutoPlay();
            englishWordDisplayEl.textContent = currentLevelData.questions[currentQuizIndex].correctWord;
            messageAreaEl.textContent = "‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!";
            messageAreaEl.style.color = 'var(--error)';
            highlightAll(false);
            endQuestion();
        }

        function highlightAll(isSuccess) {
            document.querySelectorAll('.tile').forEach(t => {
                if (t.classList.contains('selected')) t.classList.add('correct');
            });
        }

        function endQuestion() {
            stopTimer();
            const q = currentLevelData.questions[currentQuizIndex];
            speakAnswer(q.correctWord, q.thaiPrompt);
        }

        function endGame() {
            stopTimer();
            document.getElementById('pause-btn').style.display = 'none';
            document.getElementById('paused-controls').style.display = 'none';
            document.getElementById('end-level-controls').style.display = 'flex';
            document.getElementById('next-q-btn').style.display = 'none';
            messageAreaEl.textContent = "‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! üéâ";
        }

        // --- TIMERS / CONTROLS ---
        function startTimer(duration) {
            clearInterval(timerInterval);
            totalTime = duration;
            timeRemaining = duration;
            isGameActive = true;
            updateTimerBar();
            
            pauseBtn.style.display = 'block';
            if (isAutoPlayMode) pauseBtn.style.display = 'block'; // Always show pause in V6.3+

            timerInterval = setInterval(() => {
                timeRemaining -= 0.1;
                updateTimerBar();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    checkFlow(true);
                }
            }, 100);
        }

        function updateTimerBar() {
            const pct = (timeRemaining / totalTime) * 100;
            timerBarEl.style.width = `${pct}%`;
            if (pct < 30) timerBarEl.style.background = 'var(--error)';
            else timerBarEl.style.background = 'linear-gradient(90deg, var(--primary), var(--accent))';
        }

        function stopTimer() { clearInterval(timerInterval); isGameActive = false; }

        function pauseGame() {
            if (!isGameActive || isAnswered || isPaused) return;
            stopTimer();
            clearAutoPlay();
            clearTimeout(autoNextQTransitionTimeout); // Ensure auto-advance stops
            isGameActive = false; isPaused = true;
            window.speechSynthesis.cancel();
            
            document.getElementById('pause-btn').style.display = 'none';
            document.getElementById('paused-controls').style.display = 'flex';
        }

        function resumeGame() {
            startTimer(timeRemaining, true); // Re-start timer without resetting time
            isPaused = false;
            if (isAutoPlayMode) {
                const q = currentLevelData.questions[currentQuizIndex];
                startAutoPlay(q, true);
            }
        }

        function goToLevelSelect() {
            window.speechSynthesis.cancel();
            stopTimer();
            clearAutoPlay();
            clearTimeout(autoNextQTransitionTimeout);
            
            currentLevelData = null;
            showScreen('level-select-screen');
        }

        // --- AUTO PLAY LOGIC ---
        function toggleAutoPlayMode() {
            isAutoPlayMode = !isAutoPlayMode;
            const container = document.getElementById('main-container');
            if (isAutoPlayMode) container.classList.add('auto-mode-active');
            else container.classList.remove('auto-mode-active');
        }

        function clearAutoPlay() {
            if (autoPlayTimeout) clearTimeout(autoPlayTimeout);
        }

        function startAutoPlay(q, isResuming = false) {
            if (!isAutoPlayMode) return;
            
            const correctWord = q.correctWord;
            const tileElements = Array.from(document.querySelectorAll('.tile'));
            const tilesData = q.tiles; 
            
            let spellIndex = currentGuessWord.length;

            const spellNext = () => {
                if (spellIndex >= correctWord.length || isAnswered || isPaused) return;

                const targetTileData = tilesData.find(t => t.order === spellIndex + 1);
                
                if (targetTileData) {
                    const targetEl = tileElements[targetTileData.tileIndex];
                    if (targetEl && !targetEl.classList.contains('selected')) {
                        // Simulate click/input processing
                        currentGuessWord += targetTileData.char;
                        targetEl.classList.add('selected');
                        englishWordDisplayEl.textContent = currentGuessWord;
                        checkFlow();
                    }
                }
                
                spellIndex++;
                if (!isAnswered) {
                    const delay = Math.random() * 200 + 800; // 0.8 - 1.0s
                    autoPlayTimeout = setTimeout(spellNext, delay);
                }
            };

            const delay = isResuming ? 100 : Math.random() * 200 + 800;
            autoPlayTimeout = setTimeout(spellNext, delay);
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            setupSpeech();
            createLevelButtons();
            showScreen('level-select-screen'); // Show Level Select initially

            // Events
            document.getElementById('game-title').ondblclick = toggleAutoPlayMode;
            document.getElementById('pause-btn').onclick = pauseGame;
            document.getElementById('resume-btn').onclick = resumeGame;
            document.getElementById('main-menu-btn-pause').onclick = goToLevelSelect;
            document.getElementById('main-menu-btn-end').onclick = goToLevelSelect;
            document.getElementById('play-again-btn').onclick = () => {
                if (originalLevelData) startGame(originalLevelData.levelData, originalLevelData.subLevelData, true);
            };
            document.getElementById('next-q-btn').onclick = () => {
                clearTimeout(autoNextQTransitionTimeout);
                currentQuizIndex++;
                nextQuestion();
            };
        });

    </script>
</body>
</html>
