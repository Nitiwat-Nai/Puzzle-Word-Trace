<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Trace 3.0: The Pharaoh's Trace üëë (Fixed)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Global & Pharaoh Theme */
        :root {
            --color-primary: #1565C0; /* Lapis Blue */
            --color-secondary: #FFC107; /* Gold */
            --color-correct: #66BB6A; /* Green */
            --color-wrong: #EF5350; /* Red */
            --color-bg: #FFF8E1; /* Light Sand */
            --color-card: #FFFFFF; /* Ivory */
            --color-text-dark: #263238;
            --color-text-light: #FFFFFF;
            --grid-size: 4; /* Default grid size */
        }

        /* Container Styles */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
            background-color: var(--color-card);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 0;
            transition: all 0.5s ease;
        }

        /* Header */
        header {
            background-color: var(--color-primary);
            color: var(--color-secondary);
            padding: 1rem 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        header h1 {
            font-size: 1.8rem;
            margin: 0;
        }
        .version-tag {
            font-size: 0.7rem;
            font-weight: 400;
            display: block;
            margin-top: 2px;
            opacity: 0.8;
            color: var(--color-text-light);
        }

        /* Screen Management */
        .screen {
            padding: 1rem;
            display: none; 
            flex-grow: 1;
            flex-direction: column;
            justify-content: space-between;
        }
        .screen.active {
            display: flex;
        }
        
        /* --- Level Selection Screen --- */
        #level-select-screen .level-grid-select {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 1rem 0;
        }
        .level-btn {
            background-color: var(--color-secondary); 
            color: var(--color-text-dark);
            border: none;
            padding: 1.5rem 0.5rem;
            border-radius: 12px;
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #FFB300;
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.2s;
        }
        .level-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #FFB300;
        }
        
        /* Timer Bar */
        #timer-bar-container {
            width: 100%;
            height: 20px;
            background-color: #CFD8DC;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        #timer-bar {
            height: 100%;
            width: 100%; 
            background-color: var(--color-secondary);
            transition: width 0.1s linear;
        }

        /* Game Grid */
        #game-grid {
            width: 95%;
            margin: 0 auto;
            aspect-ratio: 1 / 1; 
            border: 4px solid var(--color-primary);
            border-radius: 10px;
            padding: 5px;
            display: grid;
            gap: 5px;
        }

        .tile {
            background-color: var(--color-card);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            overflow: hidden;
            border: 2px solid #E0E0E0;
        }
        
        .tile-char-wrapper {
             font-size: calc(30px + 2vw); 
             font-weight: 900;
             color: var(--color-text-dark);
             transform: rotate(var(--rotation));
             transition: transform 0.2s ease-out;
             padding: 5px;
             line-height: 1;
        }

        /* Correct/Answered Styles */
        .tile.correct {
            background-color: var(--color-secondary); /* Gold highlight */
            border-color: #FFB300;
        }
        .tile.correct .tile-char-wrapper {
            color: var(--color-text-dark); /* Dark text on Gold */
            transform: rotate(0deg) !important; 
        }

        /* Next Button */
        #next-btn {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            border: none;
            width: 100%; 
            padding: 1rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #0D47A1;
            transition: all 0.1s;
            margin-top: 2rem;
        }
        #next-btn:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0D47A1;
        }
        #next-btn:disabled {
             background-color: #B0BEC5;
             box-shadow: 0 4px 0 #90A4AE;
             cursor: default;
        }
        
        /* ... (‡∏™‡πà‡∏ß‡∏ô CSS ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏°‡∏≤‡∏Å‡∏ô‡∏±‡∏Å) ... */

    </style>
</head>
<body>

    <div class="container" id="main-container">
        <header>
            <h1>Word Trace üëë</h1>
            <span class="version-tag">Version 3.0: The Pharaoh's Trace</span>
        </header>

        <div id="level-select-screen" class="screen active">
            <h2>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏∏‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</h2>
            <p>‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà</p>
            <div class="level-grid-select" id="level-grid-select">
                </div>
        </div>
        
        <div id="game-screen" class="screen">
            <div class="top-content">
                <div class="status-bar">
                    <span id="level-title">Level: </span>
                    <span id="q-count">‡∏Ç‡πâ‡∏≠: 0/50</span>
                    <span id="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</span>
                </div>

                <div id="prompt-area">
                    <div id="thai-prompt">‡πÇ‡∏à‡∏ó‡∏¢‡πå: (‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)</div>
                    <div id="english-word-display"></div>
                </div>

                <div id="timer-bar-container">
                    <div id="timer-bar"></div>
                </div>
                
                <div id="game-grid">
                    </div>
                
                <div id="message-area"></div>
                
            </div>
            
            <button id="next-btn" disabled>‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚è≠Ô∏è/‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>
    </div>

    <script>
        // --- DATA (Word Trace Questions) ---
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏´‡∏•‡∏≠‡∏Å (Distractor) ‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°
        function getRandomDistractorChar() {
            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            return alphabet[Math.floor(Math.random() * alphabet.length)];
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Tile Data ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î)
        function generateTiles(word, minLength, gridSize) {
            const tiles = [];
            const tileCount = gridSize * gridSize;
            const wordChars = word.split('');
            const wordLength = word.length;

            // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞ rotation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (Order > 0)
            const pathIndices = [];
            while(pathIndices.length < wordLength) {
                const randomIndex = Math.floor(Math.random() * tileCount);
                if (pathIndices.indexOf(randomIndex) === -1) {
                    pathIndices.push(randomIndex);
                }
            }

            for (let i = 0; i < tileCount; i++) {
                const charIndex = pathIndices.indexOf(i);
                
                if (charIndex !== -1) {
                    // ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå
                    tiles.push({
                        char: wordChars[charIndex],
                        order: charIndex + 1,
                        correctRotation: 0, // Simplified: assume 0 degrees is correct for all
                        currentRotation: [0, 90, 180, 270][Math.floor(Math.random() * 4)] // ‡∏™‡∏∏‡πà‡∏°‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    });
                } else {
                    // ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏´‡∏•‡∏≠‡∏Å
                    tiles.push({
                        char: getRandomDistractorChar(),
                        order: 0,
                        correctRotation: 0, 
                        currentRotation: [0, 90, 180, 270][Math.floor(Math.random() * 4)]
                    });
                }
            }
            return tiles;
        }

        const level1Words = [
            { correctWord: "CAT", thaiPrompt: "‡πÅ‡∏°‡∏ß", timeLimit: 12 },
            { correctWord: "DOG", thaiPrompt: "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç", timeLimit: 12 },
            { correctWord: "SUN", thaiPrompt: "‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", timeLimit: 12 },
            { correctWord: "MOON", thaiPrompt: "‡∏û‡∏£‡∏∞‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", timeLimit: 15 },
            { correctWord: "FISH", thaiPrompt: "‡∏õ‡∏•‡∏≤", timeLimit: 15 },
            // Level 1: ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏¢‡πà‡∏≠‡∏¢ 2
            { correctWord: "TREE", thaiPrompt: "‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ", timeLimit: 12 },
            { correctWord: "BIRD", thaiPrompt: "‡∏ô‡∏Å", timeLimit: 12 },
            { correctWord: "BLUE", thaiPrompt: "‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", timeLimit: 15 },
            { correctWord: "RED", thaiPrompt: "‡∏™‡∏µ‡πÅ‡∏î‡∏á", timeLimit: 12 },
            { correctWord: "RICE", thaiPrompt: "‡∏Ç‡πâ‡∏≤‡∏ß", timeLimit: 15 },
            // Level 1: ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏¢‡πà‡∏≠‡∏¢ 3
            { correctWord: "BOOK", thaiPrompt: "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", timeLimit: 15 },
            { correctWord: "CAR", thaiPrompt: "‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå", timeLimit: 12 },
            { correctWord: "BUS", thaiPrompt: "‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á", timeLimit: 12 },
            { correctWord: "HOME", thaiPrompt: "‡∏ö‡πâ‡∏≤‡∏ô", timeLimit: 15 },
            { correctWord: "BALL", thaiPrompt: "‡∏•‡∏π‡∏Å‡∏ö‡∏≠‡∏•", timeLimit: 15 },
            // Level 1: ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏¢‡πà‡∏≠‡∏¢ 4
            { correctWord: "HAND", thaiPrompt: "‡∏°‡∏∑‡∏≠", timeLimit: 15 },
            { correctWord: "FOOT", thaiPrompt: "‡πÄ‡∏ó‡πâ‡∏≤", timeLimit: 15 },
            { correctWord: "FARM", thaiPrompt: "‡∏ü‡∏≤‡∏£‡πå‡∏°", timeLimit: 15 },
            { correctWord: "STAR", thaiPrompt: "‡∏î‡∏≤‡∏ß", timeLimit: 15 },
            { correctWord: "SHIP", thaiPrompt: "‡πÄ‡∏£‡∏∑‡∏≠", timeLimit: 15 },
            // Level 1: ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏¢‡πà‡∏≠‡∏¢ 5
            { correctWord: "RAIN", thaiPrompt: "‡∏ù‡∏ô", timeLimit: 15 },
            { correctWord: "WIND", thaiPrompt: "‡∏•‡∏°", timeLimit: 15 },
            { correctWord: "ROAD", thaiPrompt: "‡∏ñ‡∏ô‡∏ô", timeLimit: 15 },
            { correctWord: "FIRE", thaiPrompt: "‡πÑ‡∏ü", timeLimit: 15 },
            { correctWord: "LAKE", thaiPrompt: "‡∏ó‡∏∞‡πÄ‡∏•‡∏™‡∏≤‡∏ö", timeLimit: 15 },
            // (‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å 25 ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Level 1 ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö)
        ];
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const level1Questions = level1Words.map(q => ({
            ...q,
            tiles: generateTiles(q.correctWord, q.correctWord.length, 3)
        }));

        const allQuizData = [
            { 
                level: 1, 
                title: "Beginner (3x3 Grid, 3-4 Letters) - 50 Words", 
                gridSize: 3, 
                questions: level1Questions // 25 ‡∏Ñ‡∏≥‡πÅ‡∏£‡∏Å
            },
            { 
                level: 2, 
                title: "Intermediate (4x4 Grid, 5-6 Letters) - 50 Words", 
                gridSize: 4, 
                questions: [
                    // Placeholder for 50 words
                    { correctWord: "APPLE", thaiPrompt: "‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•", timeLimit: 18, tiles: generateTiles("APPLE", 5, 4) },
                    { correctWord: "PEACH", thaiPrompt: "‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä", timeLimit: 18, tiles: generateTiles("PEACH", 5, 4) },
                    { correctWord: "TIGER", thaiPrompt: "‡πÄ‡∏™‡∏∑‡∏≠", timeLimit: 18, tiles: generateTiles("TIGER", 5, 4) },
                    { correctWord: "CHAIR", thaiPrompt: "‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ", timeLimit: 18, tiles: generateTiles("CHAIR", 5, 4) },
                    { correctWord: "YELLOW", thaiPrompt: "‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", timeLimit: 20, tiles: generateTiles("YELLOW", 6, 4) },
                    // ... 45 ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ...
                ]
            },
            { 
                level: 3, 
                title: "Advanced (5x5/6x6 Grid, 7-10+ Letters) - 50 Words", 
                gridSize: 5, // ‡πÉ‡∏ä‡πâ 5x5 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÅ‡∏•‡∏∞ 6x6 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö dynamic)
                questions: [
                    // Placeholder for 50 words
                    { correctWord: "ELEPHANT", thaiPrompt: "‡∏ä‡πâ‡∏≤‡∏á", timeLimit: 25, tiles: generateTiles("ELEPHANT", 8, 5) },
                    { correctWord: "COMPUTER", thaiPrompt: "‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå", timeLimit: 25, tiles: generateTiles("COMPUTER", 8, 5) },
                    { correctWord: "LIBRARY", thaiPrompt: "‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î", timeLimit: 22, tiles: generateTiles("LIBRARY", 7, 5) },
                    { correctWord: "UNIVERSITY", thaiPrompt: "‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢", timeLimit: 30, tiles: generateTiles("UNIVERSITY", 10, 6) },
                    // ... 46 ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ...
                ]
            }
        ];

        // --- ELEMENTS ---
        const levelGridSelectEl = document.getElementById('level-grid-select');
        const levelSelectScreen = document.getElementById('level-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const levelTitleEl = document.getElementById('level-title');
        const qCountEl = document.getElementById('q-count');
        const scoreEl = document.getElementById('score');
        const thaiPromptEl = document.getElementById('thai-prompt');
        const englishWordDisplayEl = document.getElementById('english-word-display');
        const gameGridEl = document.getElementById('game-grid');
        const timerBarEl = document.getElementById('timer-bar');
        const nextBtn = document.getElementById('next-btn');
        const messageAreaEl = document.getElementById('message-area');

        // --- GAME STATE ---
        let currentLevelData = null;
        let currentQuizIndex = 0;
        let score = 0;
        let isAnswered = false;
        let timerInterval = null;
        let timeRemaining = 0;
        let totalTime = 0;
        let isGameActive = false;
        let totalPathTiles = 0;
        let utterance = null; 

        // --- TTS & UTILITY FUNCTIONS (REVISED) ---
        function setupSpeech() {
            if ('speechSynthesis' in window) {
                utterance = new SpeechSynthesisUtterance();
                utterance.volume = 1; 
                utterance.rate = 1;
                utterance.pitch = 1;
                // ‡∏•‡∏ö Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (onend) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏Å‡∏±‡∏ô
            }
        }
        
        function speak(text, lang, onEndCallback = null) { // ‡πÄ‡∏û‡∏¥‡πà‡∏° onEndCallback
            if (utterance) {
                window.speechSynthesis.cancel(); 
                utterance.text = text;
                utterance.lang = lang;
                
                const voices = window.speechSynthesis.getVoices();
                if (lang === 'en-US' || lang === 'en-GB') {
                    // ‡πÉ‡∏ä‡πâ startsWith ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤ Voice
                    utterance.voice = voices.find(v => v.lang.startsWith('en-')); 
                } else if (lang === 'th-TH') {
                    utterance.voice = voices.find(v => v.lang.startsWith('th-'));
                }
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î onend ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô callback ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                utterance.onend = onEndCallback;

                window.speechSynthesis.speak(utterance);
            }
        }
        
        function speakAnswer(englishWord, thaiMeaning) {
            
            // 1. Logic ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏à‡∏ö ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            const onThaiSpeakEnd = () => {
                 utterance.onend = null; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
                 setTimeout(() => {
                     if (!nextBtn.disabled) { 
                         currentQuizIndex++;
                         nextQuestion(); // ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                     }
                 }, 1000); 
            };
            
            // 2. Logic ‡∏Å‡∏•‡∏≤‡∏á: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏à‡∏ö ‡∏à‡∏∞‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ï‡πà‡∏≠
            const onEnglishSpeakEnd = () => {
                 // ‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ onThaiSpeakEnd ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö
                 speak(thaiMeaning, 'th-TH', onThaiSpeakEnd);
            };

            // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ onEnglishSpeakEnd ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö
            speak(englishWord, 'en-US', onEnglishSpeakEnd);
        }

        // --- UI & SCREEN MANAGEMENT ---

        function showScreen(id) {
            window.speechSynthesis.cancel();
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        function updateStatusBar() {
            levelTitleEl.textContent = `Level ${currentLevelData.level}: ${currentLevelData.title.split(' ')[0]}`;
            // Q Count now shows the full 50 questions
            qCountEl.textContent = `‡∏Ç‡πâ‡∏≠: ${currentQuizIndex + 1}/${currentLevelData.questions.length}`; 
            scoreEl.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}`;
        }
        
        // --- TIMER LOGIC (Same as V2.0) ---
        function startTimer(duration) {
            clearInterval(timerInterval);
            totalTime = duration;
            timeRemaining = duration;
            isGameActive = true;
            updateTimerBar();

            timerInterval = setInterval(() => {
                timeRemaining -= 0.1;
                if (timeRemaining <= 0) {
                    timeRemaining = 0;
                    clearInterval(timerInterval);
                    checkFlow(true); 
                }
                updateTimerBar();
            }, 100);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isGameActive = false;
        }

        function updateTimerBar() {
            const percentage = (timeRemaining / totalTime) * 100;
            timerBarEl.style.width = `${percentage}%`;
            if (percentage < 25) {
                timerBarEl.style.backgroundColor = 'var(--color-wrong)';
            } else {
                timerBarEl.style.backgroundColor = 'var(--color-secondary)';
            }
        }
        
        // --- GAME GRID LOGIC (Same as V2.0) ---
        
        function handleTileClick(event) {
            if (!isGameActive || isAnswered) return;

            const tileEl = event.currentTarget;
            let currentRot = parseInt(tileEl.getAttribute('data-rotation'));
            
            currentRot = (currentRot + 90) % 360; 
            tileEl.setAttribute('data-rotation', currentRot);
            tileEl.querySelector('.tile-char-wrapper').style.setProperty('--rotation', `${currentRot}deg`);

            checkFlow();
        }

        function createGrid(q, gridSize) {
            gameGridEl.innerHTML = '';
            gameGridEl.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            
            totalPathTiles = q.correctWord.length;

            q.tiles.forEach((tileData, index) => {
                const tileEl = document.createElement('div');
                tileEl.className = 'tile';
                tileEl.setAttribute('data-index', index);
                tileEl.setAttribute('data-rotation', tileData.currentRotation);
                tileEl.setAttribute('data-order', tileData.order); 
                
                const charWrapper = document.createElement('div');
                charWrapper.className = 'tile-char-wrapper';
                charWrapper.textContent = tileData.char;
                charWrapper.style.setProperty('--rotation', `${tileData.currentRotation}deg`);
                
                tileEl.appendChild(charWrapper);
                tileEl.addEventListener('click', handleTileClick);
                gameGridEl.appendChild(tileEl);
            });
        }
        
        function checkFlow(timeUp = false) {
            if (isAnswered) return;

            let correctTiles = 0;
            const allTiles = gameGridEl.querySelectorAll('.tile');
            const q = currentLevelData.questions[currentQuizIndex];
            
            allTiles.forEach((tileEl, index) => {
                const order = parseInt(tileEl.getAttribute('data-order'));
                if (order > 0) {
                    const currentRot = parseInt(tileEl.getAttribute('data-rotation'));
                    const correctRot = q.tiles[index].correctRotation;
                    
                    if (currentRot === correctRot) {
                        correctTiles++;
                        tileEl.classList.add('correct');
                    } else {
                        tileEl.classList.remove('correct');
                    }
                }
            });

            if (correctTiles === totalPathTiles) {
                isAnswered = true;
                score++;
                messageAreaEl.textContent = `‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Ñ‡∏∑‡∏≠ ${q.correctWord}`;
                messageAreaEl.style.color = 'var(--color-correct)';
                endQuestion(true);
            } else if (timeUp) {
                isAnswered = true;
                messageAreaEl.textContent = `‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤! ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Ñ‡∏∑‡∏≠ ${q.correctWord}`;
                messageAreaEl.style.color = 'var(--color-wrong)';
                endQuestion(false);
            }
        }
        
        // --- GAME LOGIC ---

        function createLevelButtons() {
             levelGridSelectEl.innerHTML = '';
            // Group the 50 questions into 10 groups of 5 for display
            const levelData = allQuizData.map(data => ({
                ...data,
                subLevels: Array.from({ length: 10 }, (_, i) => ({
                    id: `${data.level}-${i + 1}`,
                    title: `‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${i + 1}`,
                    questions: data.questions.slice(i * 5, (i + 1) * 5)
                }))
            }));

            levelData.forEach(data => {
                data.subLevels.forEach(subLevel => {
                    const btn = document.createElement('button');
                    btn.className = 'level-btn';
                    btn.textContent = `L${data.level} - ${subLevel.title}`;
                    
                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'level-btn-title';
                    titleSpan.textContent = subLevel.title.replace('‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà', 'Level'); // Display fix
                    
                    btn.appendChild(titleSpan);
                    btn.setAttribute('data-level-id', subLevel.id);
                    
                    btn.addEventListener('click', () => {
                        startGame(data, subLevel);
                    });
                    levelGridSelectEl.appendChild(btn);
                });
            });
        }

        function startGame(levelData, subLevelData) {
            currentLevelData = {
                ...levelData,
                questions: subLevelData.questions,
                title: `${levelData.title.split(' ')[0]} ${subLevelData.title}`
            }; 
            currentQuizIndex = 0;
            score = 0;
            
            showScreen('game-screen');
            nextQuestion();
        }

        function nextQuestion() {
            window.speechSynthesis.cancel();
            
            if (currentQuizIndex >= currentLevelData.questions.length) {
                endGame();
                return;
            }
            
            isAnswered = false;
            nextBtn.disabled = true;
            englishWordDisplayEl.textContent = ''; 
            messageAreaEl.textContent = '‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥...';
            messageAreaEl.style.color = 'var(--color-text-dark)';

            updateStatusBar();
            const q = currentLevelData.questions[currentQuizIndex];
            
            // Adjust grid size dynamically for Level 3 or specific long words
            let gridSize = currentLevelData.gridSize;
            if (q.correctWord.length > 9) { // Example for very long words
                gridSize = 6;
            }

            setupQuestion(q, gridSize);
            startTimer(q.timeLimit);
        }

        function setupQuestion(q, gridSize) {
            thaiPromptEl.textContent = `‡πÇ‡∏à‡∏ó‡∏¢‡πå: ${q.thaiPrompt}`;
            createGrid(q, gridSize);
        }
        
        function endQuestion(isCorrect) {
            stopTimer();
            isAnswered = true;
            nextBtn.disabled = false;
            updateStatusBar();
            
            const q = currentLevelData.questions[currentQuizIndex];
            
            englishWordDisplayEl.textContent = `${q.correctWord} (${q.thaiPrompt})`;
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å speakAnswer ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡πÄ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            speakAnswer(q.correctWord, q.thaiPrompt);
        }

        function endGame() {
            levelTitleEl.textContent = `‡∏à‡∏ö Level ${currentLevelData.title}!`;
            qCountEl.textContent = '';
            
            messageAreaEl.textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ ${score}/${currentLevelData.questions.length} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`;
            messageAreaEl.style.fontSize = '1.8rem';
            messageAreaEl.style.color = score >= 0.8 * currentLevelData.questions.length ? 'var(--color-correct)' : 'var(--color-wrong)';

            nextBtn.textContent = '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (Level Selection)';
            nextBtn.disabled = false;
            
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÄ‡∏Å‡∏° ‡∏õ‡∏∏‡πà‡∏° Next ‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            nextBtn.onclick = () => {
                window.speechSynthesis.cancel();
                showScreen('level-select-screen');
                nextBtn.textContent = '‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚è≠Ô∏è/‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å';
                nextBtn.onclick = null; // Reset click handler
            };
        }

        // --- INITIAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            setupSpeech();
            createLevelButtons();
            showScreen('level-select-screen');

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö nextBtn ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
            nextBtn.addEventListener('click', () => {
                 // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                 if (nextBtn.textContent.includes('‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å')) {
                     // Logic ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô endGame() ‡πÅ‡∏•‡πâ‡∏ß
                     return;
                 }

                 // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏ö‡πÄ‡∏Å‡∏° (‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏π‡∏î‡∏à‡∏ö)
                 if (isAnswered) {
                     window.speechSynthesis.cancel();
                     currentQuizIndex++;
                     nextQuestion();
                 }
            });
        });
    </script>
</body>
</html>
